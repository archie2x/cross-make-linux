#!/usr/bin/env bash
# SPDX-License-Identifier: MIT
#
# macOS linux kernel host-tools build compatibility
#  - add compatibility flags to gnu-make invocation
#  - ensure make/sed/find etc are linux kbuild compatible
#
# It invokes:
#
#   PATH=[gnu-tools] (gnu)make HOSTCFLAGS="..." HOSTCFLAGS_file2alias.o="..." "$@"
#
# The complexity is brew compatibility, error checking, and debugging.
#
# Set CML_VERBOSE to non-falsey (faLSe|nO|oFf|0) for debug
#

set -euo pipefail

# Resolve
SELF_DIR=$(dirname "$(realpath "$0")")
BREW_PREFIX=$(brew --prefix 2>/dev/null || true)
if [ -n "$BREW_PREFIX" ] &&
       [ "${SELF_DIR#${BREW_PREFIX}}" != "$SELF_DIR" ]; then
    LIBEXEC_DIR="$(brew --prefix cross-make-linux)/libexec"
else
    LIBEXEC_DIR="$SELF_DIR/../libexec"
fi

# Load / initialize
. "${LIBEXEC_DIR}/lib/common.sh"
cml_init "${SELF_DIR}"

# --- Main setup ---

cml_ensure_gnu_tool make gmake make
cml_ensure_gnu_tool sed gsed gnu-sed
cml_ensure_gnu_tool find gfind findutils
cml_ensure_gnu_tool date gdate coreutils

COMPAT_INCLUDE="${COMPAT_INCLUDE:-$(_compat_include)}"
export COMPAT_INCLUDE
if [ ! -d "$COMPAT_INCLUDE" ]; then
  echo "warning: compat include dir not found at '$COMPAT_INCLUDE'" >&2
fi
COMPAT_HOSTCFLAGS="-I${COMPAT_INCLUDE}"
COMPAT_F2A="-include ${COMPAT_INCLUDE}/uuid_wrap.h"

M_HOSTCFLAGS="$(cml_merge_make_flags HOSTCFLAGS "$COMPAT_HOSTCFLAGS" "$@")"
M_F2A="$(cml_merge_make_flags HOSTCFLAGS_file2alias.o "$COMPAT_F2A" "$@")"

cml_debug "HOSTCFLAGS=${M_HOSTCFLAGS}"
cml_debug "HOSTCFLAGS_file2alias.o=${M_F2A}"
cml_debug "make:$(command -v make)"
cml_debug "sed:$(command -v sed)"
cml_debug "find:$(command -v find)"
cml_debug "date:$(command -v date)"
cml_debug_PATH

# Execute make with composed flags
exec make \
  HOSTCFLAGS="$M_HOSTCFLAGS" \
  HOSTCFLAGS_file2alias.o="$M_F2A" \
  "$@"
